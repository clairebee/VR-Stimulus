function [animal, numCond, VRType, VRchoose] = chooseAnimal_new(dataDir, codeDir, VRchoose)

%% Get the list of animals
dir_list = dir(dataDir);
animal_list = [];
dir_list(1) = [];
dir_list(1) = [];
temp = [];
for n = 1:length(dir_list)
    if ~dir_list(n).isdir
        temp = [temp n];
    end
end
dir_list(temp) = [];
for n = 1:length(dir_list)
    mdate(n) = dir_list(n).datenum;
end
[~, dorder] = sort(mdate);
for n = length(dorder):-1:1
    animal_list = [animal_list, {dir_list(dorder(n)).name}];
end
numCond = 9;

%% Get the list of mazes
mazDir = [codeDir filesep 'Mazes'];
rmpath(genpath(mazDir));
maz_list = dir(mazDir);
maz_list(1) = [];
maz_list(1) = [];
list_maz = [];
for n = 1:length(maz_list)
    list_maz = [list_maz, {maz_list(n).name}];
end
VRType = list_maz{1};

%% Make the small GUI
VRchoose.animalChoice.secA = uiextras.HBox('Parent',VRchoose.chooseAnimal,'Spacing',10,'Padding',5);
VRchoose.animalChoice.secB = uiextras.HBox('Parent',VRchoose.chooseAnimal,'Spacing',10,'Padding',5);
VRchoose.animalChoice.chooseAnimal.Sizes = [-2 -1];

VRchoose.animalChoice.animalNameBox = uiextras.VBox('Parent',VRchoose.animalChoice.secA,'Spacing',10,'Padding',2);
VRchoose.animalChoice.mazeTypeBox = uiextras.VBox('Parent',VRchoose.animalChoice.secB,'Spacing',10,'Padding',5);
VRchoose.animalChoice.numCondBox  = uiextras.VBox('Parent',VRchoose.animalChoice.secB,'Spacing',10,'Padding',5);
VRchoose.animalChoice.secB.Sizes  = [-1 -1];
%     VRchoose.animalChoice.startExp      = uiextras.VBox('Parent',VRchoose.animalChoice.secA,'Spacing',10,'Padding',5);

% Start button
button = uicontrol('Style','pushbutton',...
    'Parent',VRchoose.animalChoice.secA,...
    ...'Position', [165 100 80 80],...
    'background','white','fontsize',14,...
    'String','LOAD','Callback', @okGo, 'Enable','off');

% f = figure('Name','Choose animal','NumberTitle','off',...
%     'MenuBar','none',...
%     'OuterPosition',[200 300 300 250]);

% Animal Choice Area
textA = uicontrol('Style','text',...
    'Parent',VRchoose.animalChoice.animalNameBox,...
    ...'Position', [5 160 150 25],...
    ...'background','white',...
    'String','Choose animal:',...
'fontsize',10,...
    'HorizontalAlignment','left');
popup = uicontrol('Style','popup',...
    'Parent',VRchoose.animalChoice.animalNameBox,...
    'String', animal_list,...
    ...'Position', [5 135 150 25],...
    ...'background','white',
    'fontsize',10,...
    'Value',1,'Callback', @animal_chosen);
textB = uicontrol('Style','text',...
    'Parent',VRchoose.animalChoice.animalNameBox,...
    ...'Position', [5 95 150 25],...
    ...'background','white',...
    'String','(or) New animal:',...
'fontsize',10,...
    'HorizontalAlignment','left');
editA = uicontrol('Style','edit',...
    'Parent',VRchoose.animalChoice.animalNameBox,...
    ...'Position', [15 70 130 25],...
    ...'background','white',
'fontsize',10,...
    'String','?','Callback', @new_animal);

VRchoose.animalChoice.animalNameBox.Sizes = [-1 -1 -1 -1];
VRchoose.animalChoice.secA.Sizes = [-3 -1];


textC = uicontrol('Style','text',...
    'Parent',VRchoose.animalChoice.numCondBox,...
    ...'Position', [125 35 100 25],...
    ...'background','white',...
    'String','Number of cond.',...
'fontsize',10,...
    'HorizontalAlignment','left');
editB = uicontrol('Style','edit',...
    'Parent',VRchoose.animalChoice.numCondBox,...
    ...'Position', [125 10 100 25],...
    ...'background','white',
    'fontsize',10,...
    'String','9','Callback', @num_trial);
textD = uicontrol('Style','text',...
    'Parent',VRchoose.animalChoice.mazeTypeBox,...
    ...'Position', [5 35 100 25],...
    ...'BackgroundColor','white',...
    'String','Maze:',...
'fontsize',10,...
    'HorizontalAlignment','left');
popup2 = uicontrol('Style','popup',...
    'Parent',VRchoose.animalChoice.mazeTypeBox,...
    'String', list_maz,...
    ...'Position', [5 10 100 25],...
    ...'background','white',
    'fontsize',10,...
    'Value',1,'Callback', @maze_chosen);
uiwait;
% close(MainFig);

    function animal_chosen(obj,event)
        animal = animal_list{popup.Value};
        AnimalDir = fullfile(dataDir, animal);
        exp = load([AnimalDir filesep 'EXP']);
        numCond = 1;
        for iStim = 1:length(exp.exp.StimVar)
            if numCond<length(exp.exp.StimVar(iStim).trialVal)
                numCond=length(exp.exp.StimVar(iStim).trialVal);
            end
        end
        editB.String = num2str(numCond);
        set(button, 'Enable', 'on', 'BackgroundColor', [0.5 1 0.5]);
        %         uiresume
    end
    function new_animal(obj,event)
        animal = editA.String;
        AnimalDir = fullfile(dataDir, animal);
        if ~exist(AnimalDir); mkdir(AnimalDir); end
        set(button, 'Enable', 'on', 'BackgroundColor', [0.5 1 0.5]);
        %         uiresume
    end
    function num_trial(obj,event)
        numCond = str2num(editB.String);
    end
    function okGo(obj,event)
        set(button, 'Enable', 'off', 'background', 'white');
        set(popup, 'Enable', 'off', 'background', 'white');
        set(popup2, 'Enable', 'off', 'background', 'white');
        set(editB, 'Enable', 'off', 'background', 'white');
        set(editA, 'Enable', 'off', 'background', 'white');
        uiresume
    end
    function maze_chosen(obj,event)
        VRType = list_maz{popup2.Value};
        addpath([mazDir filesep VRType]);
    end
end